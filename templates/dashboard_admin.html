<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrador - REPSE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #ff6a00, #ff007b, #6600ff);
      background-size: 300% 300%;
      animation: gradientShift 10s ease infinite;
      color: #fff;
      min-height: 100vh;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .card {
      background: rgba(255,255,255,0.95);
      color: #333;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .table th { background-color: #ff6a00; color: white; }

    /* --- Pestañas --- */
    .nav-tabs {
      border-bottom: 3px solid rgba(255,255,255,0.3);
      margin-bottom: 15px;
    }
    .nav-tabs .nav-link {
      color: rgba(255,255,255,0.8);
      font-weight: 500;
      border: none;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    .nav-tabs .nav-link:hover {
      color: #fff;
      border-bottom: 3px solid rgba(255,255,255,0.5);
    }
    .nav-tabs .nav-link.active {
      color: #fff !important;
      background: transparent !important;
      border-bottom: 3px solid #fff;
      font-weight: bold;
    }

    .logout-btn {
      background-color: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid #fff;
      transition: all 0.3s ease;
    }
    .logout-btn:hover {
      background-color: #fff;
      color: #6600ff;
      border-color: #fff;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h3 class="text-white mb-4">Dashboard Administrador</h3>

    <!-- PESTAÑAS -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="proveedores-tab" data-bs-toggle="tab" data-bs-target="#proveedores" type="button" role="tab">Proveedores</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="pendientes-tab" data-bs-toggle="tab" data-bs-target="#pendientes" type="button" role="tab">Usuarios Pendientes</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="gestion-tab" data-bs-toggle="tab" data-bs-target="#gestion" type="button" role="tab">Gestión de Usuarios</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="recordatorios-tab" data-bs-toggle="tab" data-bs-target="#recordatorios" type="button" role="tab">Recordatorios / Proyectos</button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- PESTAÑA PROVEEDORES (visualización) -->
      <div class="tab-pane fade show active" id="proveedores" role="tabpanel">
        {% for p in proveedores %}
        <div class="card mb-3">
          <h5>{{ p['nombre'] }} ({{ p['usuario'] }})</h5>
          <p>Correo: {{ p['correo'] }}</p>
          <h6>Proyectos:</h6>
          {% set proyectos = projects | selectattr("provider_id","equalto",p["id"]) | list %}
          {% if proyectos %}
            <ul>
              {% for proj in proyectos %}
              <li>
                {{ proj['name'] }} - {{ proj['created_at'] }}
                <ul>
                  {% set docs = documentos_por_usuario[p['id']].get(proj['id'], []) %}
                  {% for doc in docs %}
                    <li>{{ doc['tipo_documento'] }}: {{ doc['nombre_archivo'] }}</li>
                  {% endfor %}
                  {% if docs|length == 0 %}
                    <li><em>No hay documentos subidos</em></li>
                  {% endif %}
                </ul>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p><em>No hay proyectos.</em></p>
          {% endif %}
        </div>
        {% else %}
        <p>No hay proveedores registrados.</p>
        {% endfor %}
      </div>

      <!-- PESTAÑA USUARIOS PENDIENTES -->
      <div class="tab-pane fade" id="pendientes" role="tabpanel">
        {% if pendientes %}
        <table class="table table-bordered mt-3">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Usuario</th>
              <th>Correo</th>
              <th>Rol</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pendientes %}
            <tr>
              <td>{{ p['nombre'] }}</td>
              <td>{{ p['usuario'] }}</td>
              <td>{{ p['correo'] }}</td>
              <td>{% if p['rol']==1 %}Admin{% else %}Proveedor{% endif %}</td>
              <td>
                <a href="{{ url_for('accion', id=p['id'], accion='aprobar') }}" class="btn btn-success btn-sm">Aprobar</a>
                <a href="{{ url_for('accion', id=p['id'], accion='rechazar') }}" class="btn btn-danger btn-sm">Rechazar</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No hay usuarios pendientes.</p>
        {% endif %}
      </div>

      <!-- PESTAÑA GESTIÓN DE USUARIOS -->
      <div class="tab-pane fade" id="gestion" role="tabpanel">
        <p>Aquí se podrán eliminar proveedores (pendiente de implementación).</p>
      </div>

      <!-- PESTAÑA RECORDATORIOS / PROYECTOS -->
      <div class="tab-pane fade" id="recordatorios" role="tabpanel">
        <h5>Enviar recordatorio a proveedores</h5>
        <form id="recordatorioForm">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Seleccionar</th>
                <th>Proveedor</th>
                <th>Proyecto</th>
                <th>Último documento subido</th>
              </tr>
            </thead>
            <tbody>
              {% for p in proveedores %}
                {% set proyectos = projects | selectattr("provider_id","equalto",p["id"]) | list %}
                {% for proj in proyectos %}
                <tr>
                  <td><input type="checkbox" name="provider_ids" value="{{ p['id'] }}"></td>
                  <td>{{ p['nombre'] }}</td>
                  <td>{{ proj['name'] }} - {{ proj['created_at'] }}</td>
                  <td>
                    {% set docs = documentos_por_usuario[p['id']].get(proj['id'], []) %}
                    {% if docs %}
                      {{ docs[-1]['nombre_archivo'] }}
                    {% else %}
                      <em>No hay documentos</em>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
          <div class="mb-2">
            <input type="text" class="form-control" id="subject" placeholder="Asunto" value="Recordatorio de documentos REPSE">
          </div>
          <div class="mb-2">
            <textarea class="form-control" id="message" placeholder="Mensaje">Por favor, subir los documentos faltantes para sus proyectos.</textarea>
          </div>
          <button type="submit" class="btn btn-primary">Enviar recordatorio</button>
          <div id="status" class="mt-2"></div>
        </form>
      </div>

    </div>

    <a href="{{ url_for('logout') }}" class="btn logout-btn mt-3">Cerrar sesión</a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Enviar recordatorio via AJAX
    $('#recordatorioForm').on('submit', function(e){
      e.preventDefault();
      let provider_ids = [];
      $('input[name="provider_ids"]:checked').each(function(){ provider_ids.push($(this).val()); });
      let subject = $('#subject').val();
      let message = $('#message').val();

      $.ajax({
        url: "{{ url_for('send_reminder') }}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ provider_ids: provider_ids, subject: subject, message: message }),
        success: function(resp){
          $('#status').html('<div class="alert alert-success">Recordatorio enviado a '+resp.sent+' proveedor(es)</div>');
        },
        error: function(){
          $('#status').html('<div class="alert alert-danger">Error enviando recordatorio</div>');
        }
      });
    });
  </script>
</body>
</html>
