<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrador - REPSE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #ff6a00, #ff007b, #6600ff);
      background-size: 300% 300%;
      animation: gradientShift 10s ease infinite;
      color: #fff;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .card {
      background: rgba(255,255,255,0.95);
      color: #333;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .table th { background-color: #ff6a00; color: white; }
    .tab-content { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h3 class="text-white mb-4">Dashboard Administrador</h3>

    <!-- PESTA√ëAS -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="proveedores-tab" data-bs-toggle="tab" data-bs-target="#proveedores" type="button" role="tab">Proveedores</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="pendientes-tab" data-bs-toggle="tab" data-bs-target="#pendientes" type="button" role="tab">Usuarios Pendientes</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="gestion-tab" data-bs-toggle="tab" data-bs-target="#gestion" type="button" role="tab">Gesti√≥n de Usuarios</button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- üü¢ PESTA√ëA PROVEEDORES -->
      <div class="tab-pane fade show active" id="proveedores" role="tabpanel">
        <div class="row my-3">
          <div class="col-md-4">
            <input type="text" id="searchProveedor" class="form-control" placeholder="Buscar proveedor...">
          </div>
        </div>

        {% for p in proveedores %}
          <div class="card proveedor-card mb-3" data-nombre="{{ p['nombre'] }}">
            <h5>{{ p['nombre'] }} ({{ p['usuario'] }})</h5>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Documento</th>
                  <th>Archivo</th>
                  <th>Estado</th>
                  <th>Descargar</th>
                </tr>
              </thead>
              <tbody>
                {% for doc in DOCUMENTOS_OBLIGATORIOS %}
                <tr>
                  <td>{{ doc }}</td>
                  <td>
                    {% if documentos_por_usuario[p['id']].get(doc) %}
                      {{ documentos_por_usuario[p['id']][doc]['nombre_archivo'] }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if documentos_por_usuario[p['id']].get(doc) %}
                      ‚úÖ
                    {% else %}
                      ‚ùå
                    {% endif %}
                  </td>
                  <td>
                    {% if documentos_por_usuario[p['id']].get(doc) %}
                      <a href="{{ url_for('descargar', filename=documentos_por_usuario[p['id']][doc]['ruta']) }}" class="btn btn-outline-primary btn-sm">Descargar</a>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>No hay proveedores registrados.</p>
        {% endfor %}
      </div>

      <!-- üü° PESTA√ëA USUARIOS PENDIENTES -->
      <div class="tab-pane fade" id="pendientes" role="tabpanel">
        {% if pendientes %}
        <table class="table table-bordered mt-3">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Usuario</th>
              <th>Correo</th>
              <th>Rol</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pendientes %}
            <tr>
              <td>{{ p['nombre'] }}</td>
              <td>{{ p['usuario'] }}</td>
              <td>{{ p['correo'] }}</td>
              <td>{% if p['rol']==1 %}Admin{% else %}Proveedor{% endif %}</td>
              <td>
                <a href="{{ url_for('accion', id=p['id'], accion='aprobar') }}" class="btn btn-success btn-sm">Aprobar</a>
                <a href="{{ url_for('accion', id=p['id'], accion='rechazar') }}" class="btn btn-danger btn-sm">Rechazar</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No hay usuarios pendientes.</p>
        {% endif %}
      </div>

      <!-- üî¥ PESTA√ëA GESTI√ìN DE USUARIOS -->
      <div class="tab-pane fade" id="gestion" role="tabpanel">
        <h5 class="mt-3">Eliminar Proveedores</h5>
        {% if proveedores %}
        <table class="table table-bordered mt-2">
          <thead>
            <tr><th>Nombre</th><th>Usuario</th><th>Correo</th><th>Acci√≥n</th></tr>
          </thead>
          <tbody>
            {% for p in proveedores %}
            <tr>
              <td>{{ p['nombre'] }}</td>
              <td>{{ p['usuario'] }}</td>
              <td>{{ p['correo'] }}</td>
              <td>
                <button class="btn btn-danger btn-sm eliminar-btn" data-id="{{ p['id'] }}">Eliminar</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No hay proveedores registrados.</p>
        {% endif %}
      </div>
    </div>

    <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary mt-2">Cerrar sesi√≥n</a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // FILTRO Y B√öSQUEDA PROVEEDORES
    $('#searchProveedor').on('keyup', function() {
      let value = $(this).val().toLowerCase();
      $('.proveedor-card').filter(function() {
        $(this).toggle($(this).data('nombre').toLowerCase().indexOf(value) > -1)
      });
    });

    // ELIMINAR PROVEEDOR CON CONFIRMACI√ìN
    $('.eliminar-btn').on('click', function() {
      let id = $(this).data('id');
      let contrasena = prompt("Por favor, ingrese su contrase√±a de administrador para confirmar:");

      if (contrasena) {
        $.post('/admin/eliminar/' + id, { contrasena: contrasena }, function(response) {
          alert(response.mensaje);
          if (response.success) location.reload();
        });
      }
    });
  </script>
</body>
</html>
