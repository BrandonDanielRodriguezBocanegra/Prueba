<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrador - REPSE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #ff6a00, #ff007b, #6600ff);
      background-size: 300% 300%;
      animation: gradientShift 10s ease infinite;
      color: #fff;
      min-height: 100vh;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .card {
      background: rgba(255,255,255,0.95);
      color: #333;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .table th { background-color: #ff6a00; color: white; }
  </style>
</head>
<body>
<div class="container mt-4">
  <h3 class="text-white mb-4">Dashboard Administrador</h3>

  <form id="reminderForm">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Enviar Recordatorio</th>
          <th>Proveedor</th>
          <th>Proyectos</th>
        </tr>
      </thead>
      <tbody>
        {% for p in proveedores %}
        <tr>
          <td><input type="checkbox" name="provider_ids" value="{{ p['id'] }}"></td>
          <td>{{ p['nombre'] }} ({{ p['usuario'] }})</td>
          <td>
            {% for proj in proyectos_por_proveedor[p['id']] %}
              <strong>{{ proj['name'] }}</strong> - {{ proj['created_at'] }}<br>
              {% for doc in DOCUMENTOS_OBLIGATORIOS %}
                {% set uploaded = documentos_por_usuario[p['id']].get(proj['id'])|default([])|selectattr('tipo_documento','equalto',doc)|list %}
                {{ doc }}:
                {% if uploaded %}✅{{ uploaded[0]['nombre_archivo'] }}{% else %}❌{% endif %}<br>
              {% endfor %}
              <hr>
            {% else %}
              No hay proyectos
            {% endfor %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button type="submit" class="btn btn-warning">Enviar Recordatorio</button>
  </form>

  <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary mt-3">Cerrar sesión</a>
</div>

<script>
$('#reminderForm').on('submit', function(e){
  e.preventDefault();
  let selected = [];
  $('input[name="provider_ids"]:checked').each(function(){
    selected.push($(this).val());
  });
  if(selected.length===0){
    alert('Selecciona al menos un proveedor.');
    return;
  }
  let subject = 'Recordatorio de documentos REPSE';
  let message = 'Por favor sube tus documentos pendientes de tus proyectos.';
  $.ajax({
    url: '{{ url_for("send_reminder") }}',
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({provider_ids:selected, subject:subject, message:message}),
    success: function(resp){
      alert('Recordatorios enviados: ' + resp.sent);
    },
    error: function(){
      alert('Error al enviar recordatorios.');
    }
  });
});
</script>
</body>
</html>
