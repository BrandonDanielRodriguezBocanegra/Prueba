<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrador - REPSE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #ff6a00, #ff007b, #6600ff);
      background-size: 300% 300%;
      animation: gradientShift 10s ease infinite;
      color: #fff;
      min-height: 100vh;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .card {
      background: rgba(255,255,255,0.95);
      color: #333;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .table th { background-color: #ff6a00; color: white; }
    .nav-tabs .nav-link.active { color: #fff !important; border-bottom: 3px solid #fff; font-weight: bold; }
  </style>
</head>
<body>

<div class="container mt-4">
  <h3 class="text-white mb-4">Dashboard Administrador</h3>

  <!-- NAV -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#proveedores">Proveedores</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pendientes">Usuarios Pendientes</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#gestion">Gestión de Usuarios</button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- ========== TAB PROVEEDORES ========= -->
    <div class="tab-pane fade show active" id="proveedores" role="tabpanel">
      {% for p in proveedores %}
      <div class="card proveedor-card mb-3">
        <h5>{{ p.nombre }} ({{ p.usuario }})</h5>
      </div>
      {% else %}
      <p>No hay proveedores aprobados.</p>
      {% endfor %}
    </div>

    <!-- ========== TAB USUARIOS PENDIENTES ========= -->
    <div class="tab-pane fade" id="pendientes" role="tabpanel">
      {% if pendientes %}
      <table class="table table-bordered mt-3 table-light text-dark">
        <thead>
          <tr><th>Nombre</th><th>Usuario</th><th>Correo</th><th>Rol</th><th>Acciones</th></tr>
        </thead>
        <tbody>
          {% for p in pendientes %}
          <tr>
            <td>{{ p.nombre }}</td>
            <td>{{ p.usuario }}</td>
            <td>{{ p.correo }}</td>
            <td>{% if p.rol==1 %}Admin{% else %}Proveedor{% endif %}</td>
            <td>
              <a href="{{ url_for('accion', id=p.id, accion='aprobar') }}" class="btn btn-success btn-sm">Aprobar</a>
              <a href="{{ url_for('accion', id=p.id, accion='rechazar') }}" class="btn btn-danger btn-sm">Rechazar</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}<p>No hay usuarios pendientes.</p>{% endif %}
    </div>

    <!-- ========== TAB GESTIÓN DE USUARIOS ========= -->
    <div class="tab-pane fade mt-3" id="gestion">
      <h4>Gestión de Usuarios</h4>

      <table class="table table-bordered table-light text-dark mt-3">
        <thead>
          <tr><th>ID</th><th>Nombre</th><th>Usuario</th><th>Correo</th><th>Acciones</th></tr>
        </thead>
        <tbody>
          {% for p in proveedores %}
          <tr id="row-{{ p.id }}">
            <td>{{ p.id }}</td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.usuario }}</td>
            <td>{{ p.correo }}</td>
            <td>
              <!-- EDITAR (MODAL) -->
              <button class="btn btn-warning btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#modalEditar"
                data-id="{{ p.id }}"
                data-nombre="{{ p.nombre }}"
                data-correo="{{ p.correo }}"
                data-rol="{{ p.rol }}">
                Editar
              </button>

              <!-- BORRAR (USANDO data-id PARA EVITAR ERRORES JINJA/JS) -->
              <button class="btn btn-danger btn-sm" data-id="{{ p.id }}" onclick="deleteUserFromButton(this)">
                Eliminar
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <a href="{{ url_for('logout') }}" class="btn btn-light mt-3">Cerrar sesión</a>
</div>


<!-- ===================== MODAL EDITAR ===================== -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content text-dark">

      <form method="POST" action="/admin/editar">
        <div class="modal-header">
          <h5 class="modal-title">Editar Usuario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="id" id="editId">

          <label>Nombre:</label>
          <input type="text" class="form-control" name="nombre" id="editNombre" required>

          <label>Correo:</label>
          <input type="email" class="form-control" name="correo" id="editCorreo" required>

          <label>Rol:</label>
          <select class="form-control" name="rol" id="editRol">
            <option value="1">Administrador</option>
            <option value="2">Proveedor</option>
          </select>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Guardar</button>
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// PASA DATOS DEL BOTÓN AL MODAL
$('#modalEditar').on('show.bs.modal', function(e) {
  let btn = $(e.relatedTarget);
  $('#editId').val(btn.data('id'));
  $('#editNombre').val(btn.data('nombre'));
  $('#editCorreo').val(btn.data('correo'));
  $('#editRol').val(btn.data('rol'));
});

// FUNCION ELIMINAR USUARIO - LEE id DESDE data-id DEL BOTÓN
function deleteUserFromButton(btn) {
  const id = btn.getAttribute('data-id');
  deleteUser(id);
}

function deleteUser(id) {
  if (!confirm("¿Seguro que deseas eliminar este usuario? Esto eliminará todos sus datos.")) return;

  fetch("/admin/delete_user", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: id })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      // eliminar fila de la tabla sin recargar
      const row = document.getElementById("row-" + id);
      if (row) row.remove();
      alert("Usuario eliminado correctamente.");
    } else {
      alert("Error: " + (data.msg || JSON.stringify(data)));
    }
  })
  .catch(err => alert("Error: " + err));
}
</script>

</body>
</html>
